definitions: 
  env_versions: &env_versions
    flutter: stable
  scripts:
    - &get_flutter_packages
      name: Get Flutter packages
      script: |
        flutter packages pub get
    - &analyze_flutter
      name: Flutter analyze
      script: |
        flutter analyze
    - &flutter_unit_tests
      name: Flutter unit tests
      script: |
        flutter test
    - &flutter_build_webapp
      name: Flutter build webapp
      script: |
        flutter build web --release
        cd build/web
        7z a -r ../web.zip ./*
  email_develop: &email_develop
    email:
      recipients:
        - user_3@example.com
        - user_4@example.com
        - ivan@codemagic.io
  slack_publish: &slack_publish
    slack:
      channel: "#builds" 
workflows: 
  check_labels_and_build:
    triggering:
      events:
        - pull_request
    environment:
      groups:
        - GitHub Token # Set this secret in your Codemagic project
      vars:
        REPO_OWNER: ivek1337 #change to your Repo owner
        REPO_NAME: ivanyaml #change to your repo name
        PR_NUMBER: $CM_PULL_REQUEST_NUMBER #automatically fetched by Codemagic webhook on PR
    pre_clone_scripts:
      - name: Check PR labels via GitHub API
        script: |
          echo "Fetching labels for PR #$PR_NUMBER in $REPO_OWNER/$REPO_NAME..."

          labels_json=$(curl -s -H "Authorization: token $ghtoken" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/issues/$PR_NUMBER/labels")

          echo "Raw API response:"
          echo "$labels_json"

          # Test if response is a JSON array
          if ! echo "$labels_json" | jq -e 'type == "array"' > /dev/null; then
            echo "API response is not a JSON array. Aborting."
            exit 1
          fi

          echo "Labels:"
          echo "$labels_json" | jq -r '.[].name'

          # Check if label "good to merg" exists
          echo "$labels_json" | jq -e '.[] | select(.name | ascii_downcase == "good to merg")' > /dev/null

          if [ $? -eq 0 ]; then
            echo "Label 'good to merg' found. Continuing build."
          else
            echo "Label 'good to merg' not found. Stopping build."
            exit 1
          fi
    scripts:
      - name: Check PR labels via GitHub API
        script: |
          echo "Fetching labels for PR #$PR_NUMBER in $REPO_OWNER/$REPO_NAME..."

          labels_json=$(curl -s -H "Authorization: token $ghtoken" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/issues/$PR_NUMBER/labels")

          echo "Raw API response:"
          echo "$labels_json"

          # Test if response is a JSON array
          if ! echo "$labels_json" | jq -e 'type == "array"' > /dev/null; then
            echo "API response is not a JSON array. Aborting."
            exit 1
          fi

          echo "Labels:"
          echo "$labels_json" | jq -r '.[].name'

          # Check if label "good to merg" exists
          echo "$labels_json" | jq -e '.[] | select(.name | ascii_downcase == "good to merg")' > /dev/null

          if [ $? -eq 0 ]; then
            echo "Label 'good to merg' found. Continuing build."
          else
            echo "Label 'good to merg' not found. Stopping build."
            exit 1
          fi

      - name: Continue with build
        script: |
          echo "Running main build steps..."
          # Your build commands here


  label-triggered-checks:
    name: Label Triggered Checks
    triggering:
      events:
        - pull_request_labeled
      cancel_previous_builds: true
    when:
      condition: event.pull_request.labels[-1].name == "b new"
    integrations:
      app_store_connect: ivan-codemagic-demo
  
    environment:
      xcode: 16.4
      groups:
        - keystore_credentials
        - google_play
        - codepush
      ios_signing:
        distribution_type: app_store
        bundle_identifier: io.codemagic.ivanyaml
      vars:
        APP_ID: 6738692730 # <-- Use the TestFlight Apple id number (An automatically generated ID assigned to your app) found under General > App Information > Apple ID.
      flutter: stable
    scripts:
      - name: Print all PR labels
        script: |
          echo "All PR labels:"
          echo "$GITHUB_EVENT_PAYLOAD" | jq -r '.pull_request.labels[].name'

      - name: Melos&bootstrap
        script: |
          echo "FLUTTER_ROOT is set to: $FLUTTER_ROOT"
          echo "CM_BUILD_DIR is set to: $CM_BUILD_DIR"
          
          if [ -d "$CM_BUILD_DIR/.fvm/" ]; then
            echo "$CM_BUILD_DIR/.fvm/ exists."
          else
            echo "$CM_BUILD_DIR/.fvm/ does not exist, creating it now."
            mkdir -p $CM_BUILD_DIR/.fvm/
          fi
          
          ln -s $FLUTTER_ROOT $CM_BUILD_DIR/.fvm/flutter_sdk
          echo "Symbolic link created."
          echo "Verifying symbolic link..."
          ls -l $CM_BUILD_DIR/.fvm/flutter_sdk
          $CM_BUILD_DIR/.fvm/flutter_sdk/bin/flutter --version
          
          # Run commands that might fail, but continue if they do
          dart pub global activate flutterfire_cli || echo "FlutterFire CLI activation failed, continuing..."
          dart pub global activate melos || echo "Melos activation failed, continuing..."
          melos bootstrap || echo "Melos bootstrap failed, continuing..."
  
      - name: Machine Specs
        script: |
          echo "Machine: $(sysctl -n machdep.cpu.brand_string)"
          echo "CPU cores: $(sysctl -n hw.physicalcpu) physical / $(sysctl -n hw.logicalcpu) logical"
          echo "RAM: $(($(sysctl -n hw.memsize) / 1024 / 1024 / 1024)) GB"

      - name: Set up code signing settings on Xcode project
        script: | 
          xcode-project use-profiles
      - name: Get Flutter packages
        script: | 
          flutter pub get
      - name: Install pods
        script: | 
          find . -name "Podfile" -execdir pod install \;
      - name: Flutter analyze
        script: | 
          flutter analyze
      - name: Flutter unit tests
        script: | 
          flutter test
        ignore_failure: true
      - name: Flutter build ipa
        script: | 
          BUILD_NUMBER=$(($(app-store-connect get-latest-testflight-build-number "$APP_ID") + 1))
          flutter build ipa --release \
            --build-name=1.0.$BUILD_NUMBER \
            --build-number=$BUILD_NUMBER \
            --export-options-plist=/Users/builder/export_options.plist
      - name: Check .ipa Path
        script: |
          ls -R build/ios/

    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log
    publishing:
      email:
        recipients:
          - ivan@codemagic.io
          - user_2@example.com
        notify:
          success: true
          failure: true
      app_store_connect:
        auth: integration

        # Configuration related to TestFlight (optional)
        # Note: This action is performed during post-processing.
        submit_to_testflight: false
        beta_groups: # Specify the names of beta tester groups that will get access to the build once it has passed beta review.
          - group name 1
          - group name 2

        # Configuration related to App Store (optional)
        # Note: This action is performed during post-processing.
        submit_to_app_store: false


  ios-yaml-workflow:
    name: iOS Workflow
    #instance_type: mac_mini_m2
    max_build_duration: 120
    integrations:
      app_store_connect: ivan-codemagic-demo
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: '*'
          include: true
          source: true
      cancel_previous_builds: false
    environment:
      xcode: 26.1
      groups:
        - keystore_credentials
        - google_play
        - codepush
      ios_signing:
        distribution_type: app_store
        bundle_identifier: io.codemagic.ivanyaml
      vars:
        APP_ID: 6738692730 # <-- Use the TestFlight Apple id number (An automatically generated ID assigned to your app) found under General > App Information > Apple ID.
      flutter: stable
    cache:
      cache_paths:
        - ~/Library/Developer/Xcode/CompilationCache.noindex

    scripts:
      - name: Melos&bootstrap
        script: |
          echo "FLUTTER_ROOT is set to: $FLUTTER_ROOT"
          echo "CM_BUILD_DIR is set to: $CM_BUILD_DIR"
          
          if [ -d "$CM_BUILD_DIR/.fvm/" ]; then
            echo "$CM_BUILD_DIR/.fvm/ exists."
          else
            echo "$CM_BUILD_DIR/.fvm/ does not exist, creating it now."
            mkdir -p $CM_BUILD_DIR/.fvm/
          fi
          
          ln -s $FLUTTER_ROOT $CM_BUILD_DIR/.fvm/flutter_sdk
          echo "Symbolic link created."
          echo "Verifying symbolic link..."
          ls -l $CM_BUILD_DIR/.fvm/flutter_sdk
          $CM_BUILD_DIR/.fvm/flutter_sdk/bin/flutter --version
          
          # Run commands that might fail, but continue if they do
          dart pub global activate flutterfire_cli || echo "FlutterFire CLI activation failed, continuing..."
          dart pub global activate melos || echo "Melos activation failed, continuing..."
          melos bootstrap || echo "Melos bootstrap failed, continuing..."
  
      - name: Machine Specs
        script: |
          echo "Machine: $(sysctl -n machdep.cpu.brand_string)"
          echo "CPU cores: $(sysctl -n hw.physicalcpu) physical / $(sysctl -n hw.logicalcpu) logical"
          echo "RAM: $(($(sysctl -n hw.memsize) / 1024 / 1024 / 1024)) GB"

      - name: Set up code signing settings on Xcode project
        script: | 
          xcode-project use-profiles
      - name: Get Flutter packages
        script: | 
          flutter pub get
      - name: Install pods
        script: | 
          find . -name "Podfile" -execdir pod install \;
      - name: Flutter analyze
        script: | 
          flutter analyze
      - name: Flutter unit tests
        script: | 
          flutter test
        ignore_failure: true
      - name: Flutter build ipa
        script: | 
          BUILD_NUMBER=$(($(app-store-connect get-latest-testflight-build-number "$APP_ID") + 3))
          flutter build ipa --release \
            --build-name=1.0.2 \
            --build-number=$BUILD_NUMBER \
            --export-options-plist=/Users/builder/export_options.plist \
      - name: Prepare Flutter iOS Runner
        script: |
          flutter build ios --release --no-codesign
      
      - name: Build ipa for distribution
        script: |
          cd ios
          xcode-project build-ipa \
            --workspace "Runner.xcworkspace" \
            --scheme "Runner" \
            --archive-xcargs "COMPILATION_CACHE_ENABLE_CACHING=True" \
            --export-options-plist /Users/builder/export_options.plist

      - name: Check .ipa Path
        script: |
          ls -R build/ios/

      #- name: Install CodePush cli tools
      #  script: |
      #    git clone https://github.com/microsoft/code-push-server /tmp/code-push-server
      #    cd /tmp/code-push-server/cli
      #    npm install && npm run build && npm install -g
      #- name: CodePush authentication
      #  script: |
      #    code-push-standalone login "https://codepush.codemagic.io" --key $CODEPUSH_ACCESS_KEY
      #- name: CodePush add app # this script can be skipped if you have existing apps
      #  script: |
      #    code-push-standalone app add YOUR_PREFERRED_APP_NAME
      #    code-push-standalone app ls
      #- name: Install npm dependencies
      #  script: |
      #    npm install
      #- name: Codepush deployment
      #  script: |
      #    code-push-standalone release-react IVANYAML ios -d Staging # -d refers to the deployment name e.g. Production, Staging
      #    code-push-standalone release-react IVANYAML android -d Staging # -d refers to the deployment name e.g. Production, Staging
    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log
    publishing:
      email:
        recipients:
          - ivan@codemagic.io
          - user_2@example.com
        notify:
          success: true
          failure: true
      app_store_connect:
        auth: integration

        # Configuration related to TestFlight (optional)
        # Note: This action is performed during post-processing.
        submit_to_testflight: false
        beta_groups: # Specify the names of beta tester groups that will get access to the build once it has passed beta review.
          - group name 1
          - group name 2

        # Configuration related to App Store (optional)
        # Note: This action is performed during post-processing.
        submit_to_app_store: false

  ios-test-app-store-connect:
    name: iOS test app store connect
    #instance_type: mac_mini_m2
    max_build_duration: 120
    integrations:
      app_store_connect: ivan-codemagic-demo
    environment:
      xcode: 26.1
      groups:
        - keystore_credentials
        - google_play
        - codepush
      ios_signing:
        distribution_type: app_store
        bundle_identifier: io.codemagic.ivanyaml
      vars:
        APP_ID: 6738692730 # <-- Use the TestFlight Apple id number (An automatically generated ID assigned to your app) found under General > App Information > Apple ID.
      flutter: stable

    scripts:
      

      - name: Flutter build ipa
        script: | 
          BUILD_NUMBER=$(($(app-store-connect get-latest-testflight-build-number "$APP_ID") + 1))

    artifacts:
      - build/artifacts/AuthKey.p8




  android-workflow:
    name: Android Workflow
    #instance_type: mac_mini_m4
    max_build_duration: 60
    environment:
      groups:
        - keystore_credentials
        - google_play
        - codepush
      vars:
        PACKAGE_NAME: "io.codemagic.ivan"
        GOOGLE_PLAY_TRACK: internal
        submit_as_draft: true
      flutter: stable  #or we can write << : *env_versions
      android_signing:
        - android_keystore
    #triggering:
    #  events:
    #    - push
    #  branch_patterns:
    #    - pattern: '*'
    #      include: true
    #      source: true
    #  cancel_previous_builds: false
    scripts:
      - name: Set up code signing settings on Xcode project
        script: xcode-project use-profiles
      - name: Set up local.properties
        script: |
          echo "flutter.sdk=$HOME/programs/flutter" > "$CM_BUILD_DIR/android/local.properties"
      - name: Get Flutter packages
        script: |
          flutter packages pub get
      - name: Flutter analyze
        script: |
          flutter analyze
      - name: Flutter unit tests
        script: |
          flutter test
        ignore_failure: true
      - name: Build AAB with Flutter
        script: |   
          BUILD_NUMBER=$(($(google-play get-latest-build-number --package-name "$PACKAGE_NAME" --tracks="$GOOGLE_PLAY_TRACK") + 1))      
          flutter build appbundle --release \
            --build-name=1.0.$BUILD_NUMBER \
            --build-number=$BUILD_NUMBER

      - name: Install CodePush cli tools
        script: |
          git clone https://github.com/microsoft/code-push-server /tmp/code-push-server
          cd /tmp/code-push-server/cli
          npm install && npm run build && npm install -g
      - name: CodePush authentication
        script: |
          code-push-standalone login "https://codepush.codemagic.io" --key $CODEPUSH_ACCESS_KEY
      #- name: CodePush add app # this script can be skipped if you have existing apps
      #  script: |
      #    code-push-standalone app add YOUR_PREFERRED_APP_NAME
      #    code-push-standalone app ls
      - name: Install npm dependencies
        script: |
          npm install
      - name: Codepush deployment
        script: |
          code-push-standalone release-react IVANYAML ios -d Staging # -d refers to the deployment name e.g. Production, Staging
          code-push-standalone release-react IVANYAML android -d Staging # -d refers to the deployment name e.g. Production, Staging
    artifacts:
      - build/**/outputs/**/*.aab
      - build/**/outputs/**/mapping.txt
      - flutter_drive.log
    publishing:
      email:
        recipients:
          - user_1@example.com
          - user_2@example.com
        notify:
          success: true
          failure: false
      <<: *email_develop
      <<: *slack_publish
      scripts:
        - echo 'Post-publish script'
  
  web-workflow:
    name: Web app workflow
    max_build_duration: 10
    environment:
      << : *env_versions
      groups:
        - keystore_credentials
        - google_play
    scripts:
      - *get_flutter_packages
      - *analyze_flutter
      - *flutter_unit_tests
      - *flutter_build_webapp
    artifacts:
      - build/web.zip
      - flutter_drive.log
    publishing:
      <<: *email_develop
  
  flutter-ios-simulator:
    name: Flutter iOS Simulator
    environment:
      flutter: 3.27.3
      xcode: 16.3
    scripts:

      - name: Machine Specs
        script: |
          echo "Machine: $(sysctl -n machdep.cpu.brand_string)"
          echo "CPU cores: $(sysctl -n hw.physicalcpu) physical / $(sysctl -n hw.logicalcpu) logical"
          echo "RAM: $(($(sysctl -n hw.memsize) / 1024 / 1024 / 1024)) GB"
          echo "GPU Info:"
          system_profiler SPDisplaysDataType
          
      - name: Run Flutter pub get

        script: flutter pub get

      - name: Build unsigned .app for simulator

        script: flutter build ios --simulator

    artifacts:

      - build/ios/iphonesimulator/Runner.app
      #- name: install dependencies 
      #  script: flutter pub get
      #- name: Build unsigned .app
      #  script: |  
      #    xcodebuild -workspace "ios/Runner.xcworkspace" \ 
      #      -scheme "Runner" \
      #      -sdk iphonesimulator \
      #      -destination 'platform=iOS Simulator,name=iPhone 16 Pro Max,OS=18.2' \
      #      -configuration Debug \
      #      CODE_SIGN_IDENTITY="" \
      #      CODE_SIGNING_REQUIRED=NO \
      #      CODE_SIGNING_ALLOWED=NO \
      #      -derivedDataPath ios/output
    #artifacts:
      #- ios/output/Build/Products/Debug-iphonesimulator/Runner.app

  android-simulator:
    name: Android debug workflow
    scripts:
      - name: Set Android SDK location
        script: |
          echo "sdk.dir=$ANDROID_SDK_ROOT" > "$CM_BUILD_DIR/android/local.properties"          
      - name: Build Android
        script: |
          gradle init
          gradle wrapper
                    
    artifacts:
      - app/build/outputs/apk/debug/app-debug.apk

  ios-yaml-npmrc-test:
    name: iOS Workflow .npmrc test
    #instance_type: mac_mini_m2
    max_build_duration: 120
    integrations:
      app_store_connect: ivan-codemagic-demo
    
    environment:
      xcode: 26.1
      groups:
      #  - keystore_credentials
      #  - google_play
      #  - codepush
        - GitHub Token
      ios_signing:
        distribution_type: app_store
        bundle_identifier: io.codemagic.ivanyaml
      vars:
        APP_ID: 6738692730 # <-- Use the TestFlight Apple id number (An automatically generated ID assigned to your app) found under General > App Information > Apple ID.
      flutter: stable
    cache:
      cache_paths:
        - ~/Library/Developer/Xcode/CompilationCache.noindex

    scripts:
      - name: Create .npmrc file
        script: |
          echo "@YOUR_GITHUB_USERNAME:registry=https://npm.pkg.github.com" > .npmrc
          echo "//npm.pkg.github.com/:_authToken=${ghtoken}" >> .npmrc
      - name: Run .npmrc install
        script: |
          npm install
      - name: Set up code signing settings on Xcode project
        script: | 
          xcode-project use-profiles
      - name: Get Flutter packages
        script: | 
          flutter pub get
      - name: Install pods
        script: | 
          find . -name "Podfile" -execdir pod install \;

      - name: Prepare Flutter iOS Runner
        script: |
          flutter build ios --release --no-codesign
      
      - name: Build ipa for distribution
        script: |
          cd ios
          xcode-project build-ipa \
            --workspace "Runner.xcworkspace" \
            --scheme "Runner" \
            --archive-xcargs "COMPILATION_CACHE_ENABLE_CACHING=True" \
            --export-options-plist /Users/builder/export_options.plist

      - name: Throw error
        script: |
          cd ios
          xcode-project build-ipa \
            --workspace "Runner.xcworkspace" \
            --scheme "Runner" \
            --archive-xcargs "COMPILATION_CACHE_ENABLE_CACHING=True" \
            --export-options-plist /Users/builder/export_options.plist
        ignore_failure: true


    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log
    publishing:
      scripts:
        - name: Report Codemagic end status to GitLab
          script: |
            STATUS=$(curl -s -H "Content-Type: application/json" \
               -H "x-auth-token: $CM_API_TOKEN" \
               --request GET "https://api.codemagic.io/builds/$CM_BUILD_ID" ) #\
               #| jq -r '.build.buildActions[]? | select(.type=="publishing") | .status')
            echo $STATUS

      email:
        recipients:
          - ivan@codemagic.io
          - user_2@example.com
        notify:
          success: true
          failure: true
      app_store_connect:
        auth: integration

        # Configuration related to TestFlight (optional)
        # Note: This action is performed during post-processing.
        submit_to_testflight: false
        beta_groups: # Specify the names of beta tester groups that will get access to the build once it has passed beta review.
          - group name 1
          - group name 2

        # Configuration related to App Store (optional)
        # Note: This action is performed during post-processing.
        submit_to_app_store: false

  first_workflow:
    name: First workflow (build and trigger)
    max_build_duration: 60
    integrations:
      app_store_connect: ivan-codemagic-demo
    
    environment:
      xcode: 26.1
      groups:
      #  - keystore_credentials
      #  - google_play
      #  - codepush
        - GitHub Token
      ios_signing:
        distribution_type: app_store
        bundle_identifier: io.codemagic.ivanyaml
    scripts:
      - name: Build app
        script: |
          echo "Running build..."
          # Your build commands here
      - name: Fail build intentionally
        script: |
          cd ios
          xcode-project build-ipa \
            --workspace "Runner.xcworkspac" \
            --scheme "Runner" \
            --archive-xcargs "COMPILATION_CACHE_ENABLE_CACHING=True" \
            --export-options-plist /Users/builder/export_options.plist
    publishing:
      scripts:
        
        - name: Trigger second workflow for status update
          script: |
            # Set variables
            CODENAGIC_API_TOKEN=$CM_API_TOKEN   # You should set this in environment vars in Codemagic
            APP_ID="669612086bf7a6c83d46ad71"
            SECOND_WORKFLOW_ID="second_workflow"

            # Get current build status (you might define custom logic or use environment variable)
            # we will check build status in next workflow
            BUILD_ID_TO_CHECK=$CM_BUILD_ID #save this builds ID in env.variable that will be sent to new workflow
            # Trigger second workflow with curl (pass buildID as env var, CM_BRANCH is built in env var)
            curl -X POST "https://api.codemagic.io/builds" \
              -H "x-auth-token: $CM_API_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{
                \"appId\": \"$APP_ID\",
                \"workflowId\": \"$SECOND_WORKFLOW_ID\",
                \"branch\": \"$CM_BRANCH\",
                \"environment\": {
                  \"variables\": {
                    \"BUILD_ID_TO_CHECK\": \"$BUILD_ID_TO_CHECK\"
                  }
                }
              }"

  second_workflow:
    name: Second workflow (status update)
    max_build_duration: 10
    integrations:
      app_store_connect: ivan-codemagic-demo
    
    environment:
      xcode: 26.1
      groups:
      #  - keystore_credentials
      #  - google_play
      #  - codepush
        - GitHub Token
      vars:
        BUILD_STATUS: $BUILD_STATUS
        BUILD_ID_TO_CHECK: $BUILD_ID_TO_CHECK # This variable will be set by the API trigger
      ios_signing:
        distribution_type: app_store
        bundle_identifier: io.codemagic.ivanyaml
    pre_clone_scripts:
      - name: Send build status to GitLab
        script: |
          # Use GitLab API to send status here, e.g.:
          #curl --request POST "https://gitlab.example.com/api/v4/projects/PROJECT_ID/statuses/COMMIT_SHA" \
          #  --header "PRIVATE-TOKEN: your-gitlab-token" \
          #  --form "state=$BUILD_STATUS"
          # CM_API_TOKEN lives in my group GitHub Token
          # BUILD_ID_TO_CHECK is in env.variable sent here from CM API Post from workflow1
          STATUS=$(curl -s -H "Content-Type: application/json" \
               -H "x-auth-token: $CM_API_TOKEN" \
               --request GET "https://api.codemagic.io/builds/$BUILD_ID_TO_CHECK" \
               | jq -r '.build.status')
          echo $STATUS
          exit 1



